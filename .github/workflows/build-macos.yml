name: Build macOS App

on:
  push:
    branches: [ main, master ]
    paths:
      - 'tkinter_app_macos.py'
      - 'macos_app.spec'
      - '.github/workflows/build-macos.yml'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller yt-dlp requests brotli websockets mutagen pycryptodomex certifi urllib3
        
    - name: Create app icon (optional)
      run: |
        # 如果有 images.png，创建 icns 图标
        if [ -f "images.png" ]; then
          mkdir -p AppIcon.iconset
          sips -z 16 16 images.png --out AppIcon.iconset/icon_16x16.png || true
          sips -z 32 32 images.png --out AppIcon.iconset/icon_16x16@2x.png || true
          sips -z 32 32 images.png --out AppIcon.iconset/icon_32x32.png || true
          sips -z 64 64 images.png --out AppIcon.iconset/icon_32x32@2x.png || true
          sips -z 128 128 images.png --out AppIcon.iconset/icon_128x128.png || true
          sips -z 256 256 images.png --out AppIcon.iconset/icon_128x128@2x.png || true
          sips -z 256 256 images.png --out AppIcon.iconset/icon_256x256.png || true
          sips -z 512 512 images.png --out AppIcon.iconset/icon_256x256@2x.png || true
          sips -z 512 512 images.png --out AppIcon.iconset/icon_512x512.png || true
          iconutil -c icns AppIcon.iconset -o app_icon.icns || true
          rm -rf AppIcon.iconset
        fi
        
    - name: Build with PyInstaller
      run: |
        # 使用 spec 文件打包
        if [ -f "macos_app.spec" ]; then
          pyinstaller macos_app.spec --noconfirm --clean
        else
          # 备用：直接打包
          pyinstaller \
            --name "视频下载神器" \
            --onefile \
            --windowed \
            --noconfirm \
            --clean \
            --hidden-import=yt_dlp \
            --hidden-import=requests \
            --hidden-import=urllib3 \
            --hidden-import=certifi \
            --hidden-import=brotli \
            --hidden-import=websockets \
            --collect-all yt_dlp \
            tkinter_app_macos.py
        fi
        
    - name: Create DMG
      run: |
        # 创建 DMG 安装包
        mkdir -p dmg_contents
        cp -r "dist/视频下载神器.app" dmg_contents/ 2>/dev/null || cp -r dist/*.app dmg_contents/
        
        # 创建 Applications 链接
        ln -s /Applications dmg_contents/Applications
        
        # 创建 DMG
        hdiutil create -volname "视频下载神器" -srcfolder dmg_contents -ov -format UDZO "视频下载神器-macOS.dmg"
        
    - name: Upload macOS App
      uses: actions/upload-artifact@v4
      with:
        name: macos-app
        path: |
          dist/*.app
          *.dmg
        retention-days: 30
        
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          视频下载神器-macOS.dmg
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
